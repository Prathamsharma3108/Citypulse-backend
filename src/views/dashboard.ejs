<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - City Pulse</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { overflow: hidden; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-bottom: 20px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .dashboard-container { display: flex; height: calc(100vh - 40px); }
        .main-content { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; overflow: hidden; }
        .feed-column, .side-column { overflow-y: auto; padding-right: 15px; }

        /* --- NEW: IMAGE RESIZING FIX --- */
        .post-image-container img {
            max-width: 100%; /* Ensures image is never wider than its container */
            height: auto;      /* Maintains aspect ratio */
            display: block;    /* Removes extra space below the image */
            border-radius: 8px; /* Optional: adds rounded corners */
        }
    </style>
</head>
<body style="padding: 20px;">
    <div class="dashboard-container">
        
        <aside class="sidebar">
            <div class="sidebar-profile">
                <img src="<%= currentUser.profilePicture %>" alt="Profile Picture">
                <h2><%= currentUser.name %></h2>
                <p>@<%= currentUser.username %></p>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard">Dashboard</a>
                <a href="/profile">My Profile</a>
                <% if (currentUser && currentUser.isAdmin) { %>
                    <a href="/admin" style="color: #007bff; font-weight: bold;">Admin Panel</a>
                <% } %>
                <a href="/logout">Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="feed-column">
                <div class="card post-form-card">
                    <form action="/api/posts" method="POST" enctype="multipart/form-data">
                        <textarea name="content" placeholder="What's on your mind, <%= currentUser.name.split(' ')[0] %>?" required></textarea>
                        <div class="form-actions">
                            <input type="file" name="postImage" id="postImage" accept="image/*" style="display:none;">
                            <label for="postImage" class="button-secondary">Add Photo</label>
                            <button type="submit" class="button">Post</button>
                        </div>
                    </form>
                </div>
                
                <% posts.forEach(post => { %>
                    <div class="post-card" data-postid="<%= post._id %>">
                        <div class="post-header">
                            <img src="<%= post.user.profilePicture %>" alt="<%= post.user.username %>'s profile picture">
                            <a href="/profile/<%= post.user.username %>"><%= post.user.username %></a>
                        </div>
                        <% if (post.imageUrl) { %>
                            <div class="post-image-container">
                                <img src="<%= post.imageUrl %>" alt="Post image">
                            </div>
                        <% } %>
                        <div class="post-body">
                            <p><%= post.content %></p>
                        </div>
                        <div class="post-actions">
                            <button class="like-button <%= post.likes.some(like => like.equals(currentUser._id)) ? 'liked' : '' %>">
                                ‚ù§Ô∏è <span class="likes-count"><%= post.likes.length %></span>
                            </button>
                            <button class="comment-button">üí¨ <%= post.comments.length %></button>
                        </div>
                        <div class="comments-section">
                            <div class="comments-list" data-postid="<%= post._id %>">
                                <% post.comments.forEach(comment => { %>
                                    <p><a href="/profile/<%= comment.user.username %>" class="comment-username"><%= comment.user.username %></a>: <%= comment.content %></p>
                                <% }) %>
                            </div>
                            <form class="comment-form" data-postid="<%= post._id %>">
                                <input type="text" name="content" placeholder="Add a comment..." required>
                                <button type="submit">Post</button>
                            </form>
                        </div>
                    </div>
                <% }) %>
            </div>
            <div class="side-column">
                <div class="card">
                    <h3>Events Map</h3>
                    <div id="map"></div>
                    <button id="createEventBtn" class="button" style="width: 100%;">Create New Event</button>
                </div>
                <div class="card">
                    <h3>Weather in <%= currentUser.city %></h3>
                    <% if (weather && !weather.error) { %>
                        <p><strong><%= weather.main.temp %>¬∞C</strong>, <%= weather.weather[0].description %></p>
                    <% } else { %> <p>Could not load weather data.</p> <% } %>
                </div>
                <div class="card"><h3>Local News</h3><% news.forEach(article => { %><p><a href="<%= article.url %>" target="_blank"><%= article.title %></a></p><% }) %></div>
                <div class="card"><h3>Explore <%= currentUser.city %></h3><% videos.forEach(video => { %><p><a href="https://www.youtube.com/watch?v=<%= video.id.videoId %>" target="_blank"><%= video.snippet.title %></a></p><% }); %></div>
            </div>
        </main>
    </div>
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Create a New Event</h2>
            <p>The event location will be set to the current center of your map.</p>
            <form id="eventForm">
                <div class="form-group"><label for="title">Event Title</label><input type="text" id="title" name="title" required></div>
                <div class="form-group"><label for="description">Description</label><textarea id="description" name="description" required></textarea></div>
                <div class="form-group"><label for="date">Date & Time</label><input type="datetime-local" id="date" name="date" required></div>
                <button type="submit" class="button">Create Event</button>
            </form>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const lat = <%= latitude || 29.3909 %>;
        const lng = <%= longitude || 76.9635 %>;
        const map = L.map('map').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        function addEventMarker(event) { L.marker([event.location.lat, event.location.lng]).addTo(map).bindPopup(`<b>${event.title}</b><br>${event.description}`); }
        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                if (!response.ok) throw new Error('Failed to fetch events');
                const events = await response.json();
                events.forEach(addEventMarker);
            } catch (error) { console.error('Error loading events for map:', error); }
        }
        loadEvents();
        const modal = document.getElementById('eventModal'), createEventBtn = document.getElementById('createEventBtn'), closeBtn = document.querySelector('.close-button'), eventForm = document.getElementById('eventForm');
        createEventBtn.onclick = () => modal.style.display = 'flex';
        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(eventForm);
            const data = Object.fromEntries(formData.entries());
            const mapCenter = map.getCenter();
            data.lat = mapCenter.lat; data.lng = mapCenter.lng; data.organizer = "<%= currentUser.name %>";
            try {
                const response = await fetch('/api/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Failed to create event'); }
                const newEvent = await response.json();
                addEventMarker(newEvent); modal.style.display = 'none'; eventForm.reset();
            } catch (error) { console.error('Error creating event:', error); alert('Error: ' + error.message); }
        });
        document.addEventListener('click', async (event) => {
            if (event.target.closest('.like-button')) {
                const button = event.target.closest('.like-button');
                const postId = button.closest('.post-card').dataset.postid;
                try {
                    const response = await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
                    const data = await response.json();
                    button.querySelector('.likes-count').textContent = data.likesCount;
                    button.classList.toggle('liked', data.isLiked);
                } catch (error) { console.error('Error liking post:', error); }
            }
        });
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const postId = form.dataset.postid;
                const input = form.querySelector('input[name="content"]');
                const content = input.value;
                if (!content) return;
                try {
                    const response = await fetch(`/api/posts/${postId}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content }) });
                    const newComment = await response.json();
                    const commentList = document.querySelector(`.comments-list[data-postid="${postId}"]`);
                    const newCommentElement = document.createElement('p');
                    newCommentElement.innerHTML = `<a href="/profile/${newComment.user.username}" class="comment-username">${newComment.user.username}</a>: ${newComment.content}`;
                    commentList.appendChild(newCommentElement);
                    input.value = '';
                } catch (error) { console.error('Error adding comment:', error); }
            });
        });
    </script>
</body>
</html>